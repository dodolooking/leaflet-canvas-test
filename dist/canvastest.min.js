L.CanvasOverlay=L.Class.extend({initialize:function(t,a){this._userDrawFunc=t,L.setOptions(this,a)},params:function(t){return L.setOptions(this,t),this},drawing:function(t){return this._userDrawFunc=t,this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer");var a=this._map.getSize();this._canvas.width=a.x,this._canvas.height=a.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide")),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.on("resize",this._resize,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.off("resize",this._resize,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this),this_canvas=null},addTo:function(t){return t.addLayer(this),this},_resize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this._redraw()},_redraw:function(){var t=this._map.getSize(),a=this._map.getBounds(),e=180*t.x/(20037508.34*(a.getEast()-a.getWest())),i=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,{canvas:this._canvas,bounds:a,size:t,zoomScale:e,zoom:i,options:this.options}),this._frame=null},_animateZoom:function(t){var a=this._map.getZoomScale(t.zoom),e=this._map._getCenterOffset(t.center)._multiplyBy(-a).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+a+")"}}),L.canvasOverlay=function(t,a){return new L.CanvasOverlay(t,a)};var map=L.map("map").setView([40,130],4);L.tileLayer("http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,attribution:"ESRI灰色底图"}).addTo(map);var render=function(t,a){console.time("test");var e=a.canvas,s=e.getContext("2d");for(s.clearRect(0,0,e.width,e.height),i=1e5;i>=0;i--){var n=this._map.latLngToContainerPoint(new L.LatLng(Math.floor(180*Math.random()-90),Math.floor(360*Math.random()-180)));n.x>e.width||n.y>e.height||(s.fillStyle="#"+Math.floor(16777215*Math.random()).toString(16),s.strokeStyle="#"+Math.floor(16777215*Math.random()).toString(16),s.beginPath(),s.arc(n.x,n.y,2,0,2*Math.PI,!0,!0),s.closePath(),s.fill(),s.stroke())}console.timeEnd("test")};L.canvasOverlay().drawing(render).addTo(map);